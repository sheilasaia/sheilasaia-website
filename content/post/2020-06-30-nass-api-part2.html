---
title: "APIs to the Rescue (& the Census of Agriculture) Part 2"
author: "Sheila Saia"
date: '2020-07-15'
categories: ["R"]
tags: []
---



<div id="background" class="section level1">
<h1>Background</h1>
<p>In a <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>, I discussed the use of application program interfaces (APIs) in R. Specifically, I focused on accessing data from the US Department of Agriculture’s National Agricultural Statistics Survey (NASS) Quick Stats API. Since I wrote that previous blog post in January 2019, several R packages that aid access to the NASS Quick Stats API have come to my attention. With these packages, it’s much easier to access NASS Quick Stats data using R! Specifically, you don’t have to manually explore data availability or manually tidy the data you’ve retrieved, which is what I had to do when determining how to download Quick Stats irrigation data for North Carolina (NC) and when defining variables like <code>nc_irrigated</code>, respectively, in that blog post back in January 2019.</p>
</div>
<div id="goals-of-this-post" class="section level1">
<h1>Goals of This Post</h1>
<p>The main goal of this blog post is to:</p>
<ul>
<li>Use an R package to download and plot Census of Agriculture data from the NASS Quick Stats API.</li>
</ul>
<p>In addition to <a href="http://nelson.rbind.io/">Natalie Nelson</a> and Andrew Dau, who I thanked in my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>, I would also like to thank <a href="https://potterzot.com/">Nicholas Potter</a> at Washington State University for developing the <code>rnassqs</code> package and responding to my questions. I’d also like to thank my collaborator <a href="https://nksingh01.wixsite.com/nitinsingh">Nitin Singh</a> for developing interesting research questions that inspired me to streamline my R code.</p>
</div>
<div id="available-nass-api-packages" class="section level1">
<h1>Available NASS API Packages</h1>
<p>As of the posting date of this blog, there are three main packages to help R users interface with the NASS Quick Stats API:</p>
<ul>
<li><p><code>rnassqs</code> - This package was developed in 2015 by <a href="https://potterzot.com/">Nicholas Potter</a> at Washington State University and is supported by <a href="https://ropensci.org/">rOpenSci</a>. To read more about this package, see examples, submit issues/bugs, and contribute to development see <a href="https://github.com/ropensci/rnassqs">here</a>. This package is available on CRAN and you can read the manual <a href="https://cran.r-project.org/web/packages/rnassqs/rnassqs.pdf">here</a>.</p></li>
<li><p><code>usdarnass</code> - This package was developed in 2018 by <a href="https://www.robertdinterman.com/">Robert Dinterman</a> at The Ohio State University. To read more about this package, see examples, submit issues/bugs, and contribute to development see <a href="https://github.com/rdinter/usdarnass">here</a>. This package is available on CRAN and you can read the manual <a href="https://cran.r-project.org/web/packages/usdarnass/usdarnass.pdf">here</a>.</p></li>
<li><p><code>rnass</code> - This package was developed in 2015 by <a href="http://eremrah.com/">Emrah Er</a> at Ankara University. To read more about this package, see examples, submit issues/bugs, and contribute to development see <a href="https://github.com/emraher/rnass">here</a>. This package is not available on CRAN, so it would have to be installed via GitHub.</p></li>
</ul>
<p><strong>Note:</strong> In this post, I’ll present code that uses the <code>rnassqs</code> package only. However, I think it would be interesting to write a third blog post that compares all three R packages!</p>
</div>
<div id="set-up" class="section level1">
<h1>Set Up</h1>
<p>First let’s load the R libraries that we’ll need to run the code in this blog post.</p>
<pre class="r"><code>library(tidycensus)
library(tidyverse)
library(mapview)</code></pre>
<p>The <code>tidycensus</code>, <code>tidyverse</code>, <code>mapview</code> packages should all be familiar from my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>.</p>
<p>The <code>rnassqs</code> package is new to this blog post. You can use it to look up available data on the NASS Quick Stats API and access it. I recommend installing this package from GitHub because you’ll want to use the <code>nassqs_param_values()</code> function which is only available via the package version on GitHub. If you install the package through CRAN using <code>install.packages(&quot;rnassqs&quot;)</code> this function will not be included. Remember you only need to install this once but then must call it every time you start a new session.</p>
<pre class="r"><code>devtools::install_github(&quot;ropensci/rnassqs&quot;)</code></pre>
<p>Load the library.</p>
<pre class="r"><code>library(rnassqs)</code></pre>
<div id="census-api-set-up" class="section level2">
<h2>Census API Set Up</h2>
<p>As I mentioned in my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>, many APIs require that you have a personal API key to access the data stored within them. To run the code in this post you’ll need to make sure you request a Census API key (see instructions below) and a NASS API key (see instructions below). Once you have your API keys, keep them all in one safe spot. I recommend a text file somewhere rememberable on your (password protected) computer.</p>
<p>To request a Census API key, you’ll have to go <a href="https://api.census.gov/data/key_signup.html">here</a> and fill in your name and organization. Once you submit the key request, the US Census Bureau will email you a Census API key. This key is unique to the name and email you provided so be sure to keep it in a save place.</p>
<p>If you’ve never installed your Census API key in your R session, you’ll want to install your API key for later use.</p>
<pre class="r"><code>CENSUS_API_KEY &lt;- &quot;YOUR API KEY GOES HERE&quot;
census_api_key(CENSUS_API_KEY, install = TRUE)

# The second line of code above will make an entry in your .Renviron file called &quot;CENSUS_API_KEY&quot;.</code></pre>
<p>If you’ve already installed your Census API key, you should be good to go, but you can always check to make sure it’s in your R environment using the code below.</p>
<pre class="r"><code># check that it&#39;s there
Sys.getenv(&quot;CENSUS_API_KEY&quot;)</code></pre>
<p>If you want to get tabular <em>and</em> spatial census data using the <code>tidycensus</code> package, you’ll need to run the code below each time you start a new R session. Spatial census data includes, for example, census tract boundaries.</p>
<pre class="r"><code>options(tigris_use_cache = TRUE)</code></pre>
</div>
<div id="nass-api-set-up" class="section level2">
<h2>NASS API Set Up</h2>
<p>Be sure to also apply for a NASS API key, which I’ll define in a string called <code>NASS_API_KEY</code>. You can apply for a NASS API key <a href="https://quickstats.nass.usda.gov/api">here</a>. As with the Census API key, this is unique to you so be sure to keep it in a safe place.</p>
<pre class="r"><code>NASS_API_KEY &lt;- &quot;ADD YOUR NASS API KEY HERE&quot;</code></pre>
<p>If you want to save your NASS API key to your R environment, you can use the code below. Setting the NASS API key in your R environment will keep it hidden and accessible only to you. This might be important if you’re planning to pass along your script to someone else…or post it on your blog. ;)</p>
<p>To set the NASS API key your R environment you’ll have to navigate to the (hidden) .Renviron file on your computer. Then you will have to add <code>NASS_API_KEY &lt;- &quot;ADD YOUR NASS API KEY HERE&quot;</code> to that text file. Alternatively, you can also use <code>sys.setenv()</code> as indicated below. See <a href="https://rstats.wtf/r-startup.html#renviron">this tutorial</a> and <a href="https://community.rstudio.com/t/how-to-set-a-variable-in-renviron/5029">this tutorial</a>. You only need to do this once on your computer.</p>
<pre class="r"><code># add NASS_API_KEY to  your .Renviron file
sys.setenv(NASS_API_KEY &lt;- &quot;ADD YOUR NASS API KEY HERE&quot;)</code></pre>
<p>Once you’ve added the NASS API key to your computer’s .Renviron file. You’ll have to run the following code each time you start a new R session. This is because you’ll need to remind R that it has this information available in the .Renviron file.</p>
<pre class="r"><code># load your stored NASS_API_KEY it into your current R session
NASS_API_KEY &lt;- Sys.getenv(&quot;NASS_API_KEY&quot;)</code></pre>
<p>Before you can make any queries, the <code>rnassqs</code> package requires that you to set your NASS API key using the <code>nassqs_auth()</code> function.</p>
<pre class="r"><code># use your NASS_API_KEY variable (see previous code chunk) to set this as your key
nassqs_auth(key = NASS_API_KEY)

# alternatively if you don&#39;t want to store a variable called NASS_API_KEY in your current session, you can run:
# nassqs_auth(key = Sys.getenv(&quot;NASS_API_KEY&quot;))</code></pre>
</div>
</div>
<div id="looking-up-available-data" class="section level1">
<h1>Looking Up Available Data</h1>
<p>The first thing to do when building a API query is understanding what parameters you have the ability to request. You can look at a complete list of available parameters using the <code>nassqs_params()</code> function. By saving the output of this to a variable named <code>params_list</code>, you can click on the variable in our RStudio envnironment and check it out.</p>
<pre class="r"><code>params_list &lt;- nassqs_params()

# print out the parameters
params_list</code></pre>
<p>There are 40 parameters that can be specified in a query. Looking back at my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>, <strong>I was interested in exploring the fraction of irrigated acres of agricultural land in the state of North Carolina over time</strong>. To replicate this work using the <code>rnassqs</code> package, I’ll pay attention to 7 NASS API parameters: commodity description (“commodity_desc”), the short description (“short_desc”), the year (“year”), the state (“state_alpha”), the aggregation level (“agg_level_desc”), unit description (“unit_desc”), and the domain category description (“domaincat_desc”).</p>
<p>Knowing what parameters to pay attention to takes some experience working with NASS Quick Stats data. If you’re really confused, I recommend going through the NASS Quick Stats web interface <a href="https://quickstats.nass.usda.gov/">here</a>. It helped me to click through the selections to see what parameters and sub-parameters are availble. Otherwise, you can use the <code>nassqs_param_values()</code> function, which I describe in further detail below, to get a better idea of what data is available to you. The <code>nassqs_param_values()</code> function can help you make a broad query to the NASS API that returns unique paramter values (I call these sub-parameters, here) within each of the 40 parameters listed above.</p>
<p>For a very general example, say you wanted to know what states grew olives in 2017 and have county aggregated data available.</p>
<pre class="r"><code>rnassqs::nassqs_param_values(param = &quot;state_alpha&quot;, 
                             commodity_desc = &quot;OLIVES&quot;,
                             year = 2017,
                             agg_level_desc = &quot;COUNTY&quot;)</code></pre>
<p>Interesting! Looks like 12 states have counties that grew olives in 2017.</p>
<p>For an example that’s more relevant to the goals of this post, I can check (1) if irrigation data is available at a county-scale in North Carolina and (2) what wording and text formatting will be needed to access it. To do this, I set <code>param = &quot;short_desc&quot;</code> because I’m interested in knowing the options avaiable for the “short_desc” paramter. I also used other variables would further filter the result.</p>
<pre class="r"><code>rnassqs::nassqs_param_values(param = &quot;short_desc&quot;, 
                             commodity_desc = &quot;AG LAND&quot;,
                             agg_level_desc = &quot;COUNTY&quot;,
                             state_alpha = &quot;NC&quot;)</code></pre>
<p><strong>Warning</strong> In some cases you’ll submit a parameter query (or full query, more on this in the next section) that’s too large. This will result in an error message like the one above.</p>
<p>If this happens, you’ll need to need to further filter the request by adding another parameter. In this case I added <code>unit_desc = &quot;ACRES&quot;</code> to produce a smaller request. This resulted in a smaller result listing all the commodities available with acre units. It takes a little patience and fiddling to understand the structure of the NASS Quick Stats database, but with a little practice, you’ll get it!</p>
<pre class="r"><code>rnassqs::nassqs_param_values(param = &quot;short_desc&quot;, 
                             commodity_desc = &quot;AG LAND&quot;,
                             agg_level_desc = &quot;COUNTY&quot;,
                             unit_desc = &quot;ACRES&quot;,
                             state_alpha = &quot;NC&quot;)</code></pre>
<p>Great! This is more helpful than an error message. :) Ok, I’ll keep an eye on two short descriptions moving forward: “AG LAND, IRRIGATED - ACRES” and “AG LAND - ACRES” because I’ll need these to explore the fraction of irrigated acres of agricultural land in the state of North Carolina over time. I will also need to know more about the domain category description (“domaincat_desc”); please see my discussion of that paramter in my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>.</p>
<p>As another example, I looked up the years with irrigation data available at the county level in North Carolina. To do this I set <code>param = &quot;year&quot;</code> because I was interested in seeing what years are available. I used the short description from above and set the other parameters to values I knew would further filter the result.</p>
<pre class="r"><code>rnassqs::nassqs_param_values(param = &quot;year&quot;, 
                             short_desc = &quot;AG LAND, IRRIGATED - ACRES&quot;,
                             agg_level_desc = &quot;COUNTY&quot;,
                             state_alpha = &quot;NC&quot;)</code></pre>
<p>By running this we see county-wide irrigation data for NC are available for 1997, 2002, 2007, 2012, and 2017. Once we know what years are availble, we can specify that in our query by setting <code>year = 2017</code>. Alternatively, if we want all the years, we can leave the year parameter undefined to get all the years available or use special operators defined <a href="https://github.com/ropensci/rnassqs">here</a> to ask for a range of years. For example, <code>year__GE = 2000</code> would give you all years greater than or equal to 2000.</p>
</div>
<div id="api-data-query" class="section level1">
<h1>API Data Query</h1>
<p>Ok, I think it’s about time to build some full queries with the information learned above. In this case I built two lists of parameters defining: (1) irrigated acreage and (2) total acreage of agricultural lands in North Carolina.</p>
<p>It took me a little trial and error to find combinations of parameters that didn’t result in a 400 error from the NASS API. This will require a little more tidying up later on, but that’s ok. For example, including the commodity description (“commodity_desc”) and the dominant category description (“domaincat_desc”) along with the short description (“short_desc”) kept resulting in an error, so I got ride of both parameters (see below).</p>
<pre class="r"><code>
# irrigated acreage query
nc_irrig_acres_params &lt;- list(short_desc = &quot;AG LAND, IRRIGATED - ACRES&quot;,
                              unit_desc = &quot;ACRES&quot;,
                              state_alpha = &quot;NC&quot;,
                              agg_level_desc = &quot;COUNTY&quot;,
                              year__GE = 2007)
# total acreage query
nc_total_acres_params &lt;- list(short_desc = &quot;AG LAND - ACRES&quot;,
                              unit_desc = &quot;ACRES&quot;,
                              state_alpha = &quot;NC&quot;,
                              agg_level_desc = &quot;COUNTY&quot;,
                              year__GE = 2007)</code></pre>
<p>Now I’ll use the parameter lists inside the <code>nassqs()</code> function to make an official NASS API request.</p>
<pre class="r"><code># irrigated acreage query
nc_irrig_acres &lt;- nassqs(nc_irrig_acres_params)

# look at the result
head(nc_irrig_acres)</code></pre>
<p>I can do the same thing for the total acreage query.</p>
<pre class="r"><code># irrigated acreage query
nc_total_acres &lt;- nassqs(nc_total_acres_params)

# look at the result
head(nc_total_acres)</code></pre>
<p>If you don’t want to do each separately, you can also list multiple parameter values using <code>c()</code>. If I wanted the results of irrigated and total acreage together, that would require the code below.</p>
<pre class="r"><code># define parameters
nc_irrigated_params &lt;- list(short_desc = c(&quot;AG LAND, IRRIGATED - ACRES&quot;, &quot;AG LAND - ACRES&quot;),
                            unit_desc = &quot;ACRES&quot;,
                            state_alpha = &quot;NC&quot;,
                            agg_level_desc = &quot;COUNTY&quot;,
                            year__GE = 2007)

# request the data from the NASS API
nc_irrigated_raw &lt;- nassqs(nc_irrigated_params)

# look at the result
head(nc_irrigated_raw)</code></pre>
<p>That worked! Now, I want to check out the data.</p>
</div>
<div id="reformatting-api-query-output" class="section level1">
<h1>Reformatting API Query Output</h1>
<p>In my <a href="https://sheilasaia.rbind.io/post/2019-01-04-nass-api/">previous blog post</a>, I had to do quite a bit of reformatting of the output because it all came in as strings of characters. The <code>rnassqs</code> packages is great because it takes care of a lot of that initial tidying up. However, I’ll still need to do some tidying of the various columns (e.g., the “Value” column is being treated as a character with commas and some text values to note unavailable or missing data).</p>
<p>This looks ok but there are still some things that would be nice to clean up. As mentioned above, we want to focus on the acres of irrigated lands in NC. For simplicity, we’ll just look at farms/ranches with 2,000 ac or more under operation. Let’s step through each line in the piped (i.e., <code>%&gt;%</code>) code below. See the in-line comments for the details.</p>
<pre class="r"><code>nc_irrigated &lt;- nc_irrigated_raw %&gt;%
  
  # filter to select county level irrigation data where farms/ranches with 2,000+ ac operation and irrigation status to get total acres of ag land in county
  filter(agg_level_desc == &quot;COUNTY&quot;) %&gt;%
  filter(unit_desc == &quot;ACRES&quot;) %&gt;%
  filter(domaincat_desc == &quot;AREA OPERATED: (2,000 OR MORE ACRES)&quot; | domaincat_desc == &quot;IRRIGATION STATUS: (ANY ON OPERATION)&quot;) %&gt;%

  # trim white space from ends (note: &#39;Value&#39; is a character here, not a number)
  mutate(value_trim = str_trim(Value)) %&gt;%
  
  # select only the columns we&#39;ll need
  select(state_name, state_alpha, state_ansi, county_code, county_name, asd_desc,
         agg_level_desc, year, prodn_practice_desc_char = prodn_practice_desc, domaincat_desc, 
         short_desc, value_ac_per_yr_char=value_trim, unit_desc) %&gt;%
  
  # filter out entries with codes &#39;(D)&#39; and &#39;(Z)&#39;
  filter(value_ac_per_yr_char != &quot;(D)&quot; &amp; value_ac_per_yr_char != &quot;(Z)&quot;) %&gt;% 
  
  # remove commas from number values and convert to R numeric class
  mutate(value_ac_per_yr = as.numeric(str_remove(value_ac_per_yr_char, &quot;,&quot;))) %&gt;%
  
  # change blanks to underscores in prodn_practice_desc_char for latter processing
  mutate(prodn_practice_desc = str_replace_all(str_to_lower(prodn_practice_desc_char),
                                               &quot;[ ]&quot;, &quot;_&quot;)) %&gt;%
  
  # remove unnecessary columns
  select(-value_ac_per_yr_char, -prodn_practice_desc_char) %&gt;%
  #arrange(county_code, year) 
  
  # we have 2007, 2012, and 2017 data and we want irrigated land acreage and total land acreage
  # (to calculate a percentage of irrigated land) so we use n()&gt;1 to filter out counties
  # that have both types of acreage for each year
  group_by(county_code, year) %&gt;%
  filter(n()&gt;1) %&gt;%
  
  # drop columns we don&#39;t need
  select(-domaincat_desc, -short_desc) %&gt;%
  
  # pivot wide irrigated and total lands operated data and calculate percent irrigated
  pivot_wider(names_from = prodn_practice_desc, values_from = value_ac_per_yr) %&gt;%
  mutate(percent_irrigated = round(irrigated/all_production_practices*100, 1)) %&gt;%
  
  # make a column with the county name and year (we&#39;ll need this for plotting)
  mutate(county_year = paste0(str_to_lower(county_name), &quot;_&quot;, year)) %&gt;%
  
  # make GEOID column to match up with county level spatial data (we&#39;ll need this for mapping)
  mutate(GEOID = paste0(state_ansi, county_code)) %&gt;%
  ungroup()</code></pre>
<p>Let’s look at the first few rows of the final reformatted NASS data showing the amount of irrigated acres in NC for 2007, 2012, and 2017.</p>
<pre class="r"><code>head(nc_irrigated)</code></pre>
</div>
<div id="plotting-nass-data" class="section level1">
<h1>Plotting NASS Data</h1>
<p>Now that we have this nicely formatted data, we can make some figures! Let’s start by making some bar charts comparing the percentage of irrigated land in NC counties where data with available data for 2007, 2012, and 2017.</p>
<pre class="r"><code>ggplot(nc_irrigated) +
  geom_col(aes(x = factor(year), y = percent_irrigated), fill = &quot;grey50&quot;) +
  facet_wrap(~county_name) +
  xlab(&quot;Year&quot;) +
  ylab(&quot;Percent of Total Acres Irrigated (%)&quot;) +
  theme_bw()</code></pre>
<p>We can plot just the counties that have all three years of data available.</p>
<pre class="r"><code># select counties that have all three years
nc_irrigated_mult_years &lt;- nc_irrigated %&gt;%
  group_by(county_name) %&gt;%
  filter(n()&gt;2)

# plot
ggplot(nc_irrigated_mult_years) +
  geom_col(aes(x = factor(year), y = percent_irrigated), fill = &quot;grey50&quot;) +
  facet_wrap(~county_name) +
  xlab(&quot;Year&quot;) +
  ylab(&quot;Percent of Total Acres Irrigated (%)&quot;) +
  theme_bw()</code></pre>
<p>Looking at this figure, it’s hard to see any big patterns in the NASS irrigation data. We can summarize the total number of acres irrigated for all 13 counties using <code>summarize()</code>.</p>
<pre class="r"><code>nc_irrigated_summary &lt;- nc_irrigated_mult_years %&gt;%
  group_by(year) %&gt;%
  summarize(sum_irrigated_ac = sum(irrigated),
            sum_all_production_ac = sum(all_production_practices)) %&gt;%
  mutate(percent_irrigated = (sum_irrigated_ac/sum_all_production_ac) * 100)

nc_irrigated_summary</code></pre>
<p>We see that these 13 counties irrigated about 6.7% of their land in production for 2007 and 2017.</p>
<p>Besides making some bar charts we can also map the irrigation percentages by county. For now, we’ll just filter out the 2017 data for this visualization.</p>
<pre class="r"><code>nc_irrigated_2017 &lt;- nc_irrigated %&gt;%
  filter(year == 2017)</code></pre>
<p>Next we’ll use the <code>get_acs()</code> function in the <code>tidycensus</code> package with <code>geometry = TRUE</code> to download the <a href="https://www.census.gov/geo/maps-data/data/tiger.html">TIGER</a> county boundaries shape (.shp) file for NC. The variable used here (i.e., “B19013_001”) represents median income but you can use any variable you wish. We’re mostly just interested in the spatial data associated with this and will ignore the tabular (i.e., median income) data.</p>
<pre class="r"><code>nc_counties &lt;- get_acs(geography = &quot;county&quot;, state = &quot;NC&quot;, variables = &quot;B19013_001&quot;, year = 2017, geometry = TRUE, survey = &quot;acs5&quot;)</code></pre>
<p>The second last step is to join <code>nc_irrigated_2017</code> to the county boundary spatial data.</p>
<pre class="r"><code>nc_irrigated_map_2017 &lt;- left_join(nc_counties, nc_irrigated_2017, by = &quot;GEOID&quot;)</code></pre>
<p>Now we’ll use <code>mapview()</code> to make an interactive plot where counties are colored based on the percentage of irrigated land. You can hover your mouse over the counties to see the actual percentages.</p>
<pre class="r"><code># mapviewOptions(vector.palette = colorRampPalette(c(&quot;snow&quot;, &quot;darkblue&quot;, &quot;grey10&quot;)))
# mapview(nc_irrigated_map_2017, zcol = &quot;percent_irrigated&quot;, legend = FALSE)</code></pre>
<p><br/>
Some other thoughts that I wanted to mention before signing off:</p>
</div>
